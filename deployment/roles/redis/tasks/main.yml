---
- name: "Create Redis data directory using shell command"
  ansible.builtin.shell: |
    sudo mkdir -p {{ redis.data_volume }}
    sudo chown 999:999 {{ redis.data_volume }}
    sudo chmod 755 {{ redis.data_volume }}

- name: "Create Redis config directory using shell command"
  ansible.builtin.shell: |
    sudo mkdir -p /etc/redis
    sudo chmod 755 /etc/redis

- name: "Create temporary Redis config file"
  ansible.builtin.template:
    src: redis.conf.j2
    dest: "/tmp/redis.conf"
    mode: '0644'

- name: "Copy Redis configuration to system location"
  ansible.builtin.shell: |
    sudo cp /tmp/redis.conf {{ redis.config_file }}
    sudo chmod 644 {{ redis.config_file }}

- name: "Pull Redis Docker image"
  ansible.builtin.shell: |
    docker pull {{ redis.image }}:{{ redis.tag }}

- name: "Stop existing Redis container"
  ansible.builtin.shell: |
    docker stop {{ redis.name }} || true
    docker rm {{ redis.name }} || true

- name: "Run Redis container"
  ansible.builtin.shell: |
    docker run -d \
      --name {{ redis.name }} \
      --restart {{ redis.restart_policy }} \
      -p {{ redis.port }}:6379 \
      -v {{ redis.data_volume }}:/data \
      -v {{ redis.config_file }}:/etc/redis/redis.conf:ro \
      --network {{ docker.network_name }} \
      --health-cmd="redis-cli ping" \
      --health-interval=5s \
      --health-timeout=5s \
      --health-retries=5 \
      {{ redis.image }}:{{ redis.tag }} {{ redis.command | join(' ') }}
  register: redis_container

- name: "Create temporary Redis systemd service file"
  ansible.builtin.template:
    src: redis.service.j2
    dest: "/tmp/{{ redis.name }}.service"
    mode: '0644'
  when: redis.systemd_service

- name: "Install Redis systemd service"
  ansible.builtin.shell: |
    sudo cp /tmp/{{ redis.name }}.service /etc/systemd/system/{{ redis.name }}.service
    sudo systemctl daemon-reload
    sudo systemctl enable {{ redis.name }}
    sudo systemctl start {{ redis.name }}
  when: redis.systemd_service

- name: "Wait for Redis to be healthy"
  ansible.builtin.shell: |
    docker exec {{ redis.name }} redis-cli ping
  register: redis_health
  until: redis_health.stdout == "PONG"
  retries: 30
  delay: 2