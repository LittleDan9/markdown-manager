---
# Note: UI building and deployment is now handled by make deploy-ui
# This task only handles nginx configuration

- name: Create nginx web root directory
  shell: |
    sudo mkdir -p "{{ ui.nginx_root }}"
    sudo chown www-data:www-data "{{ ui.nginx_root }}"
    sudo chmod 755 "{{ ui.nginx_root }}"

- name: Create nginx production configuration
  template:
    src: nginx-production.conf.j2
    dest: "/tmp/nginx.conf"

- name: Install nginx configuration
  shell: |
    sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup.$(date +%s) || true
    sudo cp /tmp/nginx.conf /etc/nginx/nginx.conf
    sudo chown root:root /etc/nginx/nginx.conf
    sudo chmod 644 /etc/nginx/nginx.conf

- name: Copy nginx configuration files
  shell: |
    sudo mkdir -p /etc/nginx/conf.d/
    sudo cp -r "{{ playbook_dir }}/../nginx/conf.d/"* /etc/nginx/conf.d/ 2>/dev/null || true

- name: Copy nginx scripts
  shell: |
    sudo mkdir -p /etc/nginx/scripts/
    sudo cp -r "{{ playbook_dir }}/../nginx/scripts/"* /etc/nginx/scripts/ 2>/dev/null || true
    sudo chmod -R 755 /etc/nginx/scripts/ 2>/dev/null || true

- name: Test and reload nginx configuration
  shell: |
    sudo nginx -t && sudo systemctl reload nginx
  register: nginx_result
  failed_when: nginx_result.rc != 0

- name: Display nginx deployment status
  debug:
    msg: "âœ… Nginx configuration deployed successfully"