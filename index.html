<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mermaid Live Editor Modularized (Fixed Layout)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link id="default" href="css/styles.css" rel="stylesheet" />
    <!-- Load Monaco Editor AMD loader -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs/loader.js"></script>
    <!-- Load Mermaid -->
    <script src="node_modules/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
  </head>

  <body>
    <div id="container">
      <!-- ─── TOOLBAR with Fullscreen & Dark Mode toggle ─── -->
      <nav id="toolbar" class="navbar navbar-expand-lg bg-body-tertiary px-3">
        <span class="navbar-brand mb-0 h1">Mermaid Editor</span>
        <div class="ms-auto d-flex align-items-center">
          <button id="fullScreenBtn" class="btn btn-outline-primary btn-sm me-3">
            Fullscreen Diagram
          </button>
          <div class="form-check form-switch m-0">
            <input
              class="form-check-input"
              type="checkbox"
              id="themeToggle"
            />
            <label class="form-check-label mb-0" for="themeToggle">
              Dark Mode
            </label>
          </div>
        </div>
      </nav>

      <!-- ─── MAIN AREA: Editor on left, Preview on right ─── -->
      <div id="main">
        <!-- LEFT: Monaco Editor Container -->
        <div id="editorContainer">
          <div id="editor"></div>
        </div>

        <!-- RIGHT: Preview Container -->
         <div id="previewContainer">
            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <div class="btn-group">
                    <button type="button" id="zoom-in" title="Zoom In" class="btn btn-outline-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                        </svg>
                    </button>
                    <button id="zoom-out" type="button" title="Zoom Out" class="btn btn-outline-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dash-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="preview"></div>
         </div>

    <!-- ─── Module Scripts ─── -->
    <script type="module">
      // Ensure Mermaid is initialized before anything else
      if (typeof mermaid === 'undefined') {
        console.error('Mermaid failed to load. Check the script tag.');
      } else {
        mermaid.initialize({
          startOnLoad: false,
          theme: 'default',
        });
      }

      import { setupEditor } from './js/editor.js';
      import { renderPreviewOnChange } from './js/preview.js';
      import { setupThemeToggle } from './js/themeToggle.js';
      import { setupFullscreen } from './js/fullscreen.js';
      import { enableZoom } from "./js/zoom.js";

      window.addEventListener('DOMContentLoaded', async () => {
        // 2) Create the Monaco editor, then wire it up
        const editor = await setupEditor();

        // Initial render
        await renderPreviewOnChange(editor);

        // Re-render on every change
        editor.onDidChangeModelContent(() => {
          renderPreviewOnChange(editor);
        });

        // Wire up “Fullscreen Diagram” button
        setupFullscreen(editor);

        // Wire up the Dark/Light toggle (pass editor so it can re-render)
        setupThemeToggle(editor);

        enableZoom({
          previewSelector: "#preview .mermaid svg",
          zoomInBtn: "#zoom-in",
          zoomOutBtn: "#zoom-out",
          minScale: 0.2,
          maxScale: 5,
          step: 0.1,
        });
      });
    </script>
  </body>
</html>